<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .title }}</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        .funding-section {
            text-align: center;
            padding: 1.5rem;
        }
        .funding-address {
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            word-break: break-all;
            font-family: monospace;
            font-size: 0.75rem;
            color: #10b981;
        }
        .qr-container {
            display: flex;
            justify-content: center;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            margin: 1rem auto;
            width: fit-content;
        }
        .copy-btn {
            background: #f5f5f5;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            cursor: pointer;
            margin-top: 0.5rem;
        }
        .copy-btn:hover {
            background: #e5e5e5;
        }
        .status-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin: 1.5rem 0;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.875rem;
        }
        .status-waiting {
            background: #fef3c7;
            color: #92400e;
        }
        .status-funded {
            background: #d1fae5;
            color: #065f46;
        }
        .dot-pulse {
            width: 8px;
            height: 8px;
            background: currentColor;
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        .amount-display {
            font-size: 2rem;
            font-weight: 700;
            color: #10b981;
            margin: 0.5rem 0;
        }
        .amount-label {
            font-size: 0.875rem;
            color: #737373;
        }
        .info-box {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            font-size: 0.875rem;
            color: #0369a1;
        }
        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .step {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e5e5e5;
        }
        .step.active {
            background: #0a0a0a;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header compact" style="display: flex; justify-content: space-between; align-items: center;">
            <a href="/" class="back-btn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Back
            </a>
            <div class="logo">Buy WiFi</div>
        </header>

        <main class="main">
            <!-- Step 1: Loading / Generate Wallet -->
            <section id="step-loading" class="card">
                <div class="funding-section">
                    <div class="spinner" style="margin: 2rem auto;"></div>
                    <p>Generating your session wallet...</p>
                </div>
            </section>

            <!-- Step 2: Show Funding Address -->
            <section id="step-funding" class="card hidden">
                <div class="step-indicator">
                    <div class="step active"></div>
                    <div class="step"></div>
                    <div class="step"></div>
                </div>

                <div class="funding-section">
                    <h2 class="title">Fund Your Session</h2>
                    <p class="subtitle">Send CKB to this address to start your WiFi session.</p>

                    <div class="amount-display" id="required-amount">2000 CKB</div>
                    <p class="amount-label">Minimum funding (~1 hour WiFi)</p>

                    <div id="qr-code" class="qr-container"></div>

                    <div class="funding-address" id="wallet-address">Loading...</div>
                    <button class="copy-btn" onclick="copyAddress()">Copy Address</button>

                    <div class="info-box">
                        <strong>How it works:</strong><br>
                        1. Send CKB from any wallet (JoyID, Neuron, etc.)<br>
                        2. We detect your payment automatically<br>
                        3. WiFi activates instantly (2000 CKB = 1 hour)
                    </div>

                    <div class="status-indicator status-waiting" id="funding-status">
                        <span class="dot-pulse"></span>
                        <span>Waiting for funding...</span>
                    </div>
                </div>
            </section>

            <!-- Step 3: Funding Detected -->
            <section id="step-detected" class="card hidden">
                <div class="step-indicator">
                    <div class="step active"></div>
                    <div class="step active"></div>
                    <div class="step"></div>
                </div>

                <div class="funding-section">
                    <div class="success-icon" style="width: 64px; height: 64px; margin: 0 auto 1rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                    </div>
                    <h2 class="title">Payment Received!</h2>
                    <p class="subtitle">Opening payment channel...</p>

                    <div class="amount-display" id="funded-amount">0 CKB</div>
                    <p class="amount-label">Funded amount</p>

                    <div class="status-indicator status-funded">
                        <div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div>
                        <span>Setting up your session...</span>
                    </div>
                </div>
            </section>

            <!-- Step 4: Channel Open / Active -->
            <section id="step-active" class="card hidden">
                <div class="step-indicator">
                    <div class="step active"></div>
                    <div class="step active"></div>
                    <div class="step active"></div>
                </div>

                <div class="funding-section">
                    <div class="success-icon" style="width: 64px; height: 64px; margin: 0 auto 1rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                    </div>
                    <h2 class="title">WiFi Active!</h2>
                    <p class="subtitle">Your session is ready.</p>

                    <a id="session-link" href="#" class="btn btn-primary btn-block mt-6">
                        View Session
                    </a>
                </div>
            </section>
        </main>

    </div>

    <script>
        let walletId = '';
        let walletAddress = '';
        let pollInterval = null;
        const MIN_FUNDING = 2000; // CKB minimum for Perun channel (channel cell needs significant capacity)

        // MAC and IP from MikroTik captive portal redirect
        const macAddress = '{{ .macAddress }}';
        const ipAddress = '{{ .ipAddress }}';

        async function init() {
            try {
                // Request a new guest wallet from backend with MAC/IP info
                const resp = await fetch('/api/v1/wallet/guest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mac_address: macAddress,
                        ip_address: ipAddress
                    })
                });
                const data = await resp.json();

                if (!resp.ok) {
                    throw new Error(data.error || 'Failed to create wallet');
                }

                walletId = data.wallet_id;
                walletAddress = data.address;

                // Show funding step
                document.getElementById('step-loading').classList.add('hidden');
                document.getElementById('step-funding').classList.remove('hidden');

                // Display address
                document.getElementById('wallet-address').textContent = walletAddress;
                document.getElementById('required-amount').textContent = `${MIN_FUNDING}+ CKB`;

                // Generate QR code with the address
                new QRCode(document.getElementById('qr-code'), {
                    text: walletAddress,
                    width: 180,
                    height: 180,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.M
                });

                // Start polling for funding
                startPolling();

            } catch (e) {
                console.error('Init error:', e);
                alert('Error: ' + e.message);
            }
        }

        function startPolling() {
            pollInterval = setInterval(checkFunding, 3000);
        }

        async function checkFunding() {
            if (!walletId) return;

            try {
                const resp = await fetch(`/api/v1/wallet/guest/${walletId}`);
                const data = await resp.json();

                if (data.status === 'funded' || data.status === 'channel_open') {
                    clearInterval(pollInterval);

                    // Show detected step
                    document.getElementById('step-funding').classList.add('hidden');
                    document.getElementById('step-detected').classList.remove('hidden');
                    document.getElementById('funded-amount').textContent = `${data.balance_ckb} CKB`;

                    // Wait for channel to open
                    if (data.session_id) {
                        setTimeout(() => {
                            showActive(data.session_id);
                        }, 2000);
                    } else {
                        // Continue polling for session
                        pollInterval = setInterval(() => checkSession(), 2000);
                    }
                }
            } catch (e) {
                console.error('Poll error:', e);
            }
        }

        async function checkSession() {
            try {
                const resp = await fetch(`/api/v1/wallet/guest/${walletId}`);
                const data = await resp.json();

                if (data.session_id) {
                    clearInterval(pollInterval);
                    showActive(data.session_id);
                }
            } catch (e) {
                console.error('Session check error:', e);
            }
        }

        function showActive(sessionId) {
            document.getElementById('step-detected').classList.add('hidden');
            document.getElementById('step-active').classList.remove('hidden');
            document.getElementById('session-link').href = `/session/${sessionId}`;

            // Auto redirect after 2 seconds
            setTimeout(() => {
                window.location.href = `/session/${sessionId}`;
            }, 2000);
        }

        function copyAddress() {
            navigator.clipboard.writeText(walletAddress).then(() => {
                const btn = document.querySelector('.copy-btn');
                btn.textContent = 'Copied!';
                setTimeout(() => {
                    btn.textContent = 'Copy Address';
                }, 2000);
            });
        }

        init();
    </script>
</body>
</html>
